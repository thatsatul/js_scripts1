<style>
    .cb-text-user {
        color: green;
    }
</style>
<script
  src="https://code.jquery.com/jquery-3.7.0.min.js"
  integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g="
  crossorigin="anonymous">
</script>
<div class="cb-comp">
    <div class="cb-header"></div>
    <div id="cb-main" class="cb-main"></div>
    <div id="cb-footer" class="cb-footer"></div>
</div>
<script>
    const masterObj = {
        'Explore S1 Pro': {
            text: 'Redirecting to S1 Pro page',
            currentActionType: 'REDIRECT',
            url: '/s1-pro'
        },
        'Book test ride': {
            text: 'Please select your city',
            currentActionType: 'FETCH_DATA',
            entity: 'EXPERIENCE_CENTER_CITIES',
        },
        'Nothing': {
            text: 'Okay, Bye',
            currentActionType: 'END'
        }
    };
    const masterIntentObj = {
        o_ela: {
            text: 'o_ela !!! This is o_ela assistant. Please enter your name first',
            currentActionType: 'ENTER_NAME',
            placeholderText: 'Type name here..'
        },
        HI: {
            text: 'Hi {{user_name}}, nice to meet you. How can I help you',
            currentActionType: 'SELECT_OPTION',
            replaceUserData: true,
            options: [
                { text: 'Explore S1 Pro'},
                { text: 'Book test ride'},
                { text: 'Nothing' }
            ]
        },
        'ENTER_PHONE': {
            text: 'Please enter your phone number',
            currentActionType: 'ENTER_PHONE',
            placeholderText: 'Type phone here..'
        },
        'GET_EXPERIENCE_CENTERS': {
            text: 'Please select your experience center',
            currentActionType: 'FETCH_DATA',
            entity: 'EXPERIENCE_CENTERS',
        },
        'REDIRECT_TO_EXP_CENTER': {
            text: 'Redirecting to experience center',
            currentActionType: 'REDIRECT_TO_EXP_CENTER',
        }
    };
    const conversationArr = [];
    const dummyClient = () => {
        const dummyServerObj = dummyServer();
        const userInputState = {};
        const init = () => {
            const replyObj = dummyServerObj.getReply('', 'o_ela');
            replyObj.usertype = 'BOT';
            conversationArr.push(replyObj);
            console.log('conversationArr 1', conversationArr);
            parseConversationThreads();
        }
        const sendUserInput = (inp, extra = {}) => {
            conversationArr.push({ text: inp, usertype: 'USER' });
            parseConversationThreads();
            _showLoading();
            console.log('Sending inp and intent', inp, extra);
            const replyObj = dummyServerObj.getReply(inp, extra.nextIntent);
            replyObj.usertype = 'BOT';
            conversationArr.push(replyObj);
            console.log('conversationArr 2', conversationArr);
            const tmOut = setTimeout(() => {
                clearTimeout(tmOut);
                parseConversationThreads();
            }, 1500);
        }
        const parseConversationThreads = () => {
            _clearConversationDom();
            if (conversationArr.length === 0) {
                return;
            } else {
                conversationArr.forEach((thr, indx) => {
                    const isLast = indx === conversationArr.length - 1;
                    if (isLast) {
                        parseConversationThread(thr, isLast);
                    }
                });
            }
        }
        const parseConversationThread = (currentThread, isLast) => {
            if (currentThread.currentActionType !== 'FETCH_DATA') {
                _removeLoading();
            }
            currentThread.isLast = isLast;
            if (currentThread.replaceUserData) {
                currentThread.text = currentThread.text.replace('{{user_name}}', userInputState.name);
            }
            if (
                currentThread.currentActionType === 'USER_INPUT'
                || currentThread.currentActionType === 'ENTER_NAME'
                || currentThread.currentActionType === 'ENTER_PHONE'
            ) {
                _createDomToFetchUserInput(currentThread);
            } else if (currentThread.currentActionType === 'SELECT_OPTION') {
                _createTextAndOptionsDom(currentThread);
            } else if (currentThread.currentActionType === 'REDIRECT') {
                location.href = currentThread.url;
            } else if (currentThread.currentActionType === 'FETCH_DATA') {
                _createDomPostDataFetch(currentThread);
            } else if (currentThread.currentActionType === 'END') {
                _createTextDom(currentThread);
            } else if (currentThread.currentActionType === 'REDIRECT_TO_EXP_CENTER') {
                const expCode = userInputState.expCitiesCenters[currentThread.passedInput];
                location.href = `/experience-centres/book-appointment?expCenterId=${expCode}`;
            } else {
                _createTextDom(currentThread);
            }
        }

        const _createTextDom = (obj) => {
            const cbComp = document.getElementById('cb-main');
            const textDom = document.createElement('div');
            textDom.classList.add(`cb-text-${obj.usertype === 'BOT' ? 'bot' : 'user'}`);
            textDom.innerText = obj.text;
            cbComp.appendChild(textDom);
        }

        const _createDomPostDataFetch = (obj) => {
            _createTextDom(obj);
            if (!obj.isLast) {
                return;
            }
            if (obj.entity === 'EXPERIENCE_CENTER_CITIES') {
                _fetchExpCitiesData();
            } else if (obj.entity === 'EXPERIENCE_CENTERS') {
                _fetchExpCentersData();
            }
        }

        const _createDomToFetchUserInput = (obj) => {
            _createTextDom(obj);
            if (!obj.isLast) {
                return;
            }
            _createDomToEnterInput(obj);
        }

        const _createTextAndOptionsDom = (obj) => {
            _createTextDom(obj);
            if (!obj.isLast) {
                return;
            }
            _createOptionsDom(obj.options);
        }

        const _createDomToEnterInput = (obj) => {
            const placeholderText = obj.placeholderText || 'Type here...';
            const inputDom = document.createElement('input');
            inputDom.classList.add('cb-input');
            inputDom.classList.add('cb-temp');
            inputDom.setAttribute('type', 'text');
            inputDom.setAttribute('placeholder', placeholderText);
            inputDom.addEventListener('keyup', (e) => {
                if (e.keyCode === 13) {
                    const inp = e.target.value;
                    const extra = {};
                    if (obj.currentActionType === 'ENTER_NAME') {
                        userInputState.name = inp;
                        extra.nextIntent = 'ENTER_PHONE';
                    } else if (obj.currentActionType === 'ENTER_PHONE') {
                        userInputState.phone = inp;
                        extra.nextIntent = 'HI';
                    }
                    sendUserInput(inp, extra);
                    e.target.value = '';
                }
            });
            const cbFooter = document.querySelector('.cb-footer');
            cbFooter.appendChild(inputDom);
        }

        const _createOptionsDom = (options, nextIntent) => {
            _removeLoading();
            const cbComp = document.getElementById('cb-main');
            const optionsDom = document.createElement('div');
            optionsDom.classList.add('cb-options');
            optionsDom.classList.add('cb-temp');
            options.forEach((opt) => {
                const optionDom = document.createElement('div');
                optionDom.classList.add('cb-option');
                optionDom.innerText = opt.text;
                optionDom.addEventListener('click', (e) => {
                    const inp = e.target.innerText;
                    sendUserInput(inp, { nextIntent });
                });
                optionsDom.appendChild(optionDom);
            });
            cbComp.appendChild(optionsDom);
        }

        const _fetchExpCitiesData = (obj) => {
            jQuery.ajax({
                url: 'https://kong-o_ela-apigateway-oem-stg.o_elacabs-dev.in/api/contact/v1/city-codes',
                type: 'GET',
                success: function (response) {
                    window.cities = response.data;
                    window.cities.forEach((city) => {
                        userInputState.expCities = userInputState.expCities || {};
                        userInputState.expCities[city.cityName] = city.cityCode;
                        city.text = city.cityName;
                    });
                    _createOptionsDom(window.cities, 'GET_EXPERIENCE_CENTERS');
                },
                error: function (error) {
                    console.log(error);
                },
            });
        }

        const _fetchExpCentersData = (obj) => {
            jQuery.ajax({
                url: 'https://kong-o_ela-apigateway-oem-stg.o_elacabs-dev.in/thor/v1/testride/getByCityCodeCampInfo/unauth-check-service?exp_center=ACTIVE&city_code=DEL',
                type: 'GET',
                success: function (response) {
                    window.expCentrs = response.data.exp_center;
                    window.expCentrs.forEach((expCentr) => {
                        userInputState.expCitiesCenters = userInputState.expCitiesCenters || {};
                        userInputState.expCitiesCenters[expCentr.name] = expCentr.businessUnitId;
                        expCentr.text = expCentr.name;
                    });
                    _createOptionsDom(window.expCentrs, 'REDIRECT_TO_EXP_CENTER');
                },
                error: function (error) {
                    console.log(error);
                },
            });
        }

        const _clearConversationDom = () => {
            const els = document.getElementsByClassName('cb-temp');
            if (!els || els.length === 0) {
                return;
            }
            for (var i = 0; i < els.length; i++) {
                els[i].remove();
            }
            document.getElementById('cb-footer').innerHTML = '';
        }

        const _showLoading = () => {
            const cbComp = document.getElementById('cb-main');
            const loadingDom = document.createElement('div');
            loadingDom.setAttribute('id', 'cb-loading');
            loadingDom.innerText = 'Loading...';
            cbComp.appendChild(loadingDom);
        }

        const _removeLoading = () => {
            const loadingDom = document.getElementById('cb-loading');
            if (!loadingDom) {
                return;
            }
            loadingDom.remove();
        }

        return {
            init,
            sendUserInput,
        };
    }

    const dummyServer = () => {
        const getReply = (ukey, intent) => {
            if (masterObj[ukey]) {
                return masterObj[ukey];
            }
            else if (masterIntentObj[intent]) {
                const masterIntentCopy = JSON.parse(JSON.stringify(masterIntentObj[intent]));
                masterIntentCopy.passedInput = ukey;
                return masterIntentCopy;
            }
        }
        return {
            getReply
        };
    }

    const dummyClientObj = dummyClient();
    dummyClientObj.init();
</script>
