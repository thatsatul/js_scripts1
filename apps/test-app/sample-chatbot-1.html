<style>
    .cb-main {
        padding-bottom: 120px;
    }
    .cb-comp {
      width: 375px;
      height: 520px;
      background: linear-gradient(180deg, #E8EFF2 12.34%, #FFFFFF 94.23%);
      box-shadow: 0px 0px 1px rgba(0, 0, 0, 0.24), 0px 4px 8px rgba(0, 0, 0, 0.06);
      border-radius: 4px;
      overflow: auto;
      bottom: 67px;
      right: 0;
      max-height: calc(100vh - 96px);
      position: absolute;
      padding: 88px 20px 0;
      max-width: calc(100vw - 40px);
  }
  .cb-text-bot {
      background: #F8FAFB;
      border: 0.5px solid rgba(0, 0, 0, 0.07);
      border-radius: 8px 8px 8px 0px;
      padding: 12px 16px;
      max-width: 100%;
      width: 290px;
      font-size: 16px;
      line-height: 140%;
      letter-spacing: -0.01em;
      color: #41515C;
  }
  #cb-footer {
      position: absolute;
      width: 100%;
      left: 0;
      bottom: 0;
  }
  input.cb-input.cb-temp {
      background: #FFFFFF;
      border-top: 1px solid #E0E0E0 !important;
      position: fixed;
      width: 100%;
      max-width: 100%;
      height: 60px;
      margin-top: -61px;
      display: flex;
      align-items: center;
      border: none;
      width: calc(100% - 56px);
      font-size: 16px;
      line-height: 19px;
      outline: none;
      color: #41515C;
      padding: 0 24px;
      font-family: 'Gentona-Regular';
  }
  .cb-text-user {
      background: #E0FEF5;
      border-radius: 8px 8px 0px 8px;
      border: none;
      padding: 12px 16px;
      width: 290px;
      max-width: 100%;
      font-size: 16px;
      line-height: 140%;
      letter-spacing: -0.01em;
      color: #181E22;
      display: flex;
      flex-wrap: wrap;
      justify-content: flex-start;
      margin: 15px 0px 15px 53px;
  }
  .cb-options.cb-temp {
      border: 0.5px solid rgba(0,0,0,.1);
      width: 200px;
      border-radius: 8px 8px 8px 0;
      margin: 15px 0 15px 142px;
  }
  .cb-option {
      width: 200px;
      border-bottom: 0.5px solid rgba(0, 0, 0, 0.1);
      max-width: 100%;
      border-right: 0.5px solid rgba(0, 0, 0, 0.1);
      margin: 0 auto;
      display: flex;
      align-items: center;
      font-size: 16px;
      line-height: 130%;
      letter-spacing: -0.02em;
      color: #1D67DD;
      font-family: 'Gentona-Medium';
      background: #F8FAFB;
      padding: 16px;
      cursor: pointer;
      box-sizing: border-box;
  }
    .cb-temp-hide {
        display: none !important;
    }
    .cb-text-user {
        color: green;
    }
  </style>
  <script
  src="https://code.jquery.com/jquery-3.7.0.min.js"
  integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g="
  crossorigin="anonymous">
  </script>
  <div class="cb-comp">
    <div class="cb-header"></div>
    <div id="cb-main" class="cb-main"></div>
    <div id="cb-footer" class="cb-footer">
        <div>
            <input type="text" id="cb-input-exp-cities" class="cb-input cb-temp cb-temp-hide" placeholder="Start typing city name here..." value="">
        </div>
    </div>
  </div>
  <script>
    let debounceTimer = null;
    const masterObj = {
        'Explore S1 Pro': {
            text: 'Redirecting to S1 Pro page',
            currentActionType: 'REDIRECT',
            url: '/s1-pro'
        },
        'Book test ride': {
            text: '',
            currentActionType: 'FETCH_DATA',
            entity: 'EXPERIENCE_CENTER_CITIES',
            successText: 'Please start entering city name',
            failedText: 'Sorry, no city found',
        },
        'Nothing': {
            text: 'Okay, Bye',
            currentActionType: 'END'
        }
    };
    const masterIntentObj = {
        o_ela: {
            text: 'o_ela !!! This is o_ela assistant. Please enter your name first',
            currentActionType: 'ENTER_NAME',
            placeholderText: 'Type name here..'
        },
        HI: {
            text: 'Hi {{user_name}}, nice to meet you. How can I help you',
            currentActionType: 'SELECT_OPTION',
            replaceUserData: true,
            options: [
                { text: 'Explore S1 Pro'},
                { text: 'Book test ride'},
                { text: 'Nothing' }
            ]
        },
        'ENTER_PHONE': {
            text: 'Please enter your phone number',
            currentActionType: 'ENTER_PHONE',
            placeholderText: 'Type phone here..'
        },
        'GET_EXPERIENCE_CENTERS': {
            text: '',
            currentActionType: 'FETCH_DATA',
            entity: 'EXPERIENCE_CENTERS',
            successText: 'Please select your experience center',
            failedText: 'Sorry, no experience center found in your city',
        },
        'REDIRECT_TO_EXP_CENTER': {
            text: 'Redirecting to experience center',
            currentActionType: 'REDIRECT_TO_EXP_CENTER',
        }
    };
    let conversationArr = localStorage.getItem('conversationArr');
    conversationArr = conversationArr ? JSON.parse(conversationArr) : [];
    const dummyClient = () => {
        const dummyServerObj = dummyServer();
        let userInputState = localStorage.getItem('userInputState');
        userInputState = userInputState ? JSON.parse(userInputState) : {};
        const init = () => {
            if (conversationArr && conversationArr.length > 0) {
                conversationArr.forEach((obj) => {
                    parseConversationThread(obj);
                });
                return;
            }
            const replyObj = dummyServerObj.getReply('', 'o_ela');
            conversationArr.push(replyObj);
            console.log('conversationArr 1', conversationArr);
            parseConversationThread(replyObj);
        }
        const sendUserInput = (inp, extra = {}) => {
            const userInputObj = { text: inp, usertype: 'USER' };
            conversationArr.push(userInputObj);
            parseConversationThread(userInputObj);
            _showLoading();
            console.log('Sending inp and intent', inp, extra);
            const replyObj = dummyServerObj.getReply(inp, extra.nextIntent);
            if (replyObj.replaceUserData) {
                replyObj.text = replyObj.text.replace('{{user_name}}', userInputState.name);
                conversationArr.push({ text: replyObj.text });
            } else if (replyObj.currentActionType !== 'FETCH_DATA') {
              conversationArr.push({ text: replyObj.text });
            }
            console.log('conversationArr 2', conversationArr);
            const tmOut = setTimeout(() => {
                clearTimeout(tmOut);
                parseConversationThread(replyObj);
            }, 1500);
        }
        const parseConversationThread = (currentThread) => {
          _clearConversationDom();
            if (currentThread.currentActionType !== 'FETCH_DATA') {
                _removeLoading();
            }
            if (currentThread.replaceUserData) {
                currentThread.text = currentThread.text.replace('{{user_name}}', userInputState.name);
            }
            if (
                currentThread.currentActionType === 'USER_INPUT'
                || currentThread.currentActionType === 'ENTER_NAME'
                || currentThread.currentActionType === 'ENTER_PHONE'
            ) {
                _createDomToFetchUserInput(currentThread);
            } else if (currentThread.currentActionType === 'SELECT_OPTION') {
                _createTextAndOptionsDom(currentThread);
            } else if (currentThread.currentActionType === 'REDIRECT') {
                location.href = currentThread.url;
            } else if (currentThread.currentActionType === 'FETCH_DATA') {
                _createDomPostDataFetch(currentThread);
            } else if (currentThread.currentActionType === 'END') {
                _createTextDom(currentThread);
            } else if (currentThread.currentActionType === 'REDIRECT_TO_EXP_CENTER') {
                _saveConversation();
                const expCode = userInputState.expCitiesCenters[currentThread.passedInput];
                location.href = `/experience-centres/book-appointment?expCenterId=${expCode}`;
            } else {
                _createTextDom(currentThread);
            }
        }
  
        const _createTextDom = (obj) => {
            const cbComp = document.getElementById('cb-main');
            const textDom = document.createElement('div');
            textDom.classList.add(`cb-text-${obj.usertype === 'USER' ? 'user' : 'bot'}`);
            textDom.innerText = obj.text;
            cbComp.appendChild(textDom);
        }
  
        const _createDomPostDataFetch = (obj) => {
            if (obj.entity === 'EXPERIENCE_CENTER_CITIES') {
                _fetchExpCitiesData(obj);
            } else if (obj.entity === 'EXPERIENCE_CENTERS') {
                _fetchExpCentersData(obj);
            }
        }
  
        const _createDomToFetchUserInput = (obj) => {
            _createTextDom(obj);
            _createDomToEnterInput(obj);
        }
  
        const _createTextAndOptionsDom = (obj) => {
            _createTextDom(obj);
            _createOptionsDom(obj.options);
        }
  
        const _createDomToEnterInput = (obj) => {
            const placeholderText = obj.placeholderText || 'Type here...';
            const inputDom = document.createElement('input');
            inputDom.classList.add('cb-input');
            inputDom.classList.add('cb-temp');
            inputDom.setAttribute('type', 'text');
            inputDom.setAttribute('placeholder', placeholderText);
            inputDom.addEventListener('keyup', (e) => {
                if (e.keyCode === 13) {
                    const inp = e.target.value;
                    const extra = {};
                    if (obj.currentActionType === 'ENTER_NAME') {
                        userInputState.name = inp;
                        extra.nextIntent = 'ENTER_PHONE';
                    } else if (obj.currentActionType === 'ENTER_PHONE') {
                        userInputState.phone = inp;
                        extra.nextIntent = 'HI';
                    }
                    sendUserInput(inp, extra);
                    e.target.value = '';
                }
            });
            const cbFooter = document.querySelector('.cb-footer');
            cbFooter.appendChild(inputDom);
        }
  
        const _createOptionsDom = (options, nextIntent) => {
            _removeLoading();
            const cbComp = document.getElementById('cb-main');
            const optionsDom = document.createElement('div');
            optionsDom.classList.add('cb-options');
            optionsDom.classList.add('cb-temp');
            options.forEach((opt) => {
                const optionDom = document.createElement('div');
                optionDom.classList.add('cb-option');
                optionDom.innerText = opt.text;
                optionDom.addEventListener('click', (e) => {
                    const inp = e.target.innerText;
                    sendUserInput(inp, { nextIntent });
                });
                optionsDom.appendChild(optionDom);
            });
            cbComp.appendChild(optionsDom);
        }
  
        const _fetchExpCitiesData = (obj) => {
            jQuery.ajax({
                url: 'https://kong-o_ela-apigateway-oem-stg.o_elacabs-dev.in/api/contact/v1/city-codes',
                type: 'GET',
                success: function (response) {
                    const cities = response.data;
                    if (!cities || cities.length === 0) {
                      obj.text = obj.failedText;
                    } else {
                      obj.text = obj.successText;
                    }
                    conversationArr.push({ text: obj.text });
                    cities.forEach((city) => {
                        userInputState.expCities = userInputState.expCities || {};
                        userInputState.expCities[city.cityName] = city.cityCode;
                        city.text = city.cityName;
                    });
                    window.cities = cities;
                    _createTextDom(obj);
                    document.getElementById('cb-input-exp-cities').classList.remove('cb-temp-hide');
                    // _createOptionsDom(cities, 'GET_EXPERIENCE_CENTERS');
                },
                error: function (error) {
                    console.log(error);
                },
            });
        }
  
        const _fetchExpCentersData = (obj) => {
            const cityCode = userInputState.expCities[obj.passedInput];
            jQuery.ajax({
                url: `https://kong-o_ela-apigateway-oem-stg.o_elacabs-dev.in/thor/v1/testride/getByCityCodeCampInfo/unauth-check-service?exp_center=ACTIVE&city_code=${cityCode}`,
                type: 'GET',
                success: function (response) {
                    const expCentrs = response.data.exp_center;
                    if (!expCentrs || expCentrs.length === 0) {
                      obj.text = obj.failedText;
                    } else {
                      obj.text = obj.successText;
                    }
                    conversationArr.push({ text: obj.text });
                    expCentrs.forEach((expCentr) => {
                        userInputState.expCitiesCenters = userInputState.expCitiesCenters || {};
                        userInputState.expCitiesCenters[expCentr.name] = expCentr.businessUnitId;
                        expCentr.text = expCentr.name;
                    });
                    window.expCentrs = expCentrs;
                    _createTextDom(obj);
                    _createOptionsDom(expCentrs, 'REDIRECT_TO_EXP_CENTER');
                },
                error: function (error) {
                    console.log(error);
                },
            });
        }
  
        const _clearConversationDom = () => {
            const els = document.getElementsByClassName('cb-temp');
            if (!els || els.length === 0) {
                return;
            }
            for (var i = 0; i < els.length; i++) {
                // els[i].remove();
                els[i].classList.add('cb-temp-hide');
            }
        }
  
        const _createFilterCitiesDom = (inp) => {
          let expCitiesListEl = document.getElementById('cb-exp-cities-list');
          if (!expCitiesListEl) {
              // create div element
              expCitiesListEl = document.createElement('div');
              expCitiesListEl.setAttribute('id', 'cb-exp-cities-list');
              expCitiesListEl.classList.add('cb-temp');
              expCitiesListEl.classList.add('cb-options');
          } else {
              expCitiesListEl.innerHTML = '';
          }
          if (!window.cities || window.cities.length === 0) {
              return;
          }
          window.cities
          .filter(city => {
              // regex check val in city
              const regex = new RegExp(inp, 'gi');
              return city.cityName.match(regex);
          })
          .forEach((opt) => {
            const optionDom = document.createElement('div');
            optionDom.classList.add('cb-option');
            optionDom.innerText = opt.text;
            optionDom.addEventListener('click', (e) => {
                const inp = e.target.innerText;
                sendUserInput(inp, { nextIntent: 'GET_EXPERIENCE_CENTERS' });
            });
            expCitiesListEl.appendChild(optionDom);
          });
          const cbComp = document.getElementById('cb-main');
          cbComp.appendChild(expCitiesListEl);
        }
  
        window._debounce = (type, val) => {
          clearTimeout(debounceTimer);
          debounceTimer = setTimeout(() => {
              if (type === 'EXPERIENCE_CENTER_CITIES') {
                  _createFilterCitiesDom(val);
              }
          }, 800);
        }
  
        const _showLoading = () => {
            const cbComp = document.getElementById('cb-main');
            const loadingDom = document.createElement('div');
            loadingDom.setAttribute('id', 'cb-loading');
            loadingDom.innerText = 'Loading...';
            cbComp.appendChild(loadingDom);
        }
  
        const _removeLoading = () => {
            const loadingDom = document.getElementById('cb-loading');
            if (!loadingDom) {
                return;
            }
            loadingDom.remove();
        }
  
        const _saveConversation = () => {
          localStorage.setItem('conversationArr', JSON.stringify(conversationArr));
          localStorage.setItem('userInputState', JSON.stringify(userInputState));
        }
  
        return {
            init,
            sendUserInput,
        };
    }
  
    const dummyServer = () => {
        const getReply = (ukey, intent) => {
            if (masterObj[ukey]) {
                return JSON.parse(JSON.stringify(masterObj[ukey]));
            }
            else if (masterIntentObj[intent]) {
                const masterIntentCopy = JSON.parse(JSON.stringify(masterIntentObj[intent]));
                masterIntentCopy.passedInput = ukey;
                return masterIntentCopy;
            }
        }
        return {
            getReply
        };
    }
    const registerFuncs = () => {
      document.getElementById("cb-input-exp-cities").addEventListener("keyup", function(event) {
        const val = event.target.value;
        if (val && val.length >= 3) {
            window._debounce('EXPERIENCE_CENTER_CITIES', val);
        }
      });
    }
    registerFuncs();
    const dummyClientObj = dummyClient();
    dummyClientObj.init();
  </script>
